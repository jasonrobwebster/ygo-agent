# Appendix: `YGOProEnv` to `YgoCoreAdapter` Refactor Plan

This document serves as a detailed, function-level guide for refactoring the `YGOProEnv` class into a thin wrapper around a new `YgoCoreAdapter` class. The goal is to isolate all direct interactions with the `ygopro-core` C-API into the adapter, leaving `YGOProEnv` to manage environment-level concerns like state, rewards, and player interaction.

---
### Status Key
*   **Pending**: Implementation has not started.
*   **Adapted**: The functionality has been implemented in `YgoCoreAdapter`, but `YGOProEnv` has not yet been updated to use it.
*   **Refactored**: The logic has been fully moved to `YgoCoreAdapter`, or in the case of helper functions, moved to a more appropriate utility file.
*   **Done**: No refactoring was required for this item.
---

## 1. Helper Functions & Data Structures

These are standalone utilities currently within `ygopro.h`. They are not directly part of the `YGOProEnv` class but are used by it.

**Action:** Move these to a new, shared header file, e.g., `ygoenv/ygopro/utils.h`, so both the adapter and the environment can access them if needed.

| Function/Struct | Current Location | Target Location | Notes | Status |
| :--- | :--- | :--- | :--- | :--- |
| `combinations()` | `ygopro.h` | `utils.h` | General-purpose combination utility. | Refactored |
| `sum_to()` | `ygopro.h` | `utils.h` | Helper for `combinations_with_weight`. | Refactored |
| `combinations_with_weight()` | `ygopro.h` | `utils.h` | Used for MSG_SELECT_SUM. | Refactored |
| `msg_to_string()` | `ygopro.h` | `utils.h` | Debugging utility. | Refactored |
| `ls_to_spec()`, `spec_to_ls()` | `ygopro.h` | `utils.h` | Location/spec string conversion. | Refactored |
| `read_decks()` | `ygopro.h` | `utils.h` | Deck reading utility. | Refactored |
| `LegalAction` struct | `ygopro.h` | `ygo_data_types.h` | Becomes a core data structure. | Refactored |
| `Card` class | `ygopro.h` | `ygo_data_types.h` | Methods are now inline in this file. | Refactored |
| `init_module()` | `ygopro.h` | `YgoCoreAdapter` | Becomes a static method on the adapter. | Pending |

---

## 2. Member Variables

The member variables of `YGOProEnv` will be split. The adapter will own everything related to the core duel engine, while the environment will retain variables related to the Gym/EnvPool interface.

| `YGOProEnv` Member | To `YgoCoreAdapter`? | Notes | Status |
| :--- | :--- | :--- | :--- |
| `pduel_` | **Yes** | **Central change.** The adapter will create, own, and destroy `pduel`. | Adapted |
| `buf_` | **Yes** | The buffer for receiving messages from `YGO_GetMessage`. | Pending |
| `data_` | **Yes** | The `byte*` pointer to `buf_`. | Pending |
| `dp_` | **Yes** | Data pointer for reading `buf_`. | Pending |
| `qbuf_` | **Yes** | Buffer for query results. | Pending |
| `spec_` | No | Belongs to the EnvPool environment. | Done |
| `done_` | No | Environment state. | Done |
| `reward_` | No | Environment state. | Done |
| `turn_` | **Yes** | The core engine tracks the turn. Will be retrieved via a getter. | Pending |
| `player_` | No | Player object (e.g., RandomAI, HumanPlayer). | Done |
| `legal_actions_` | No | Actions are an environment-level concept. Populated from a getter. | Done |
| `replay_` | **Yes** | Replay buffer and logic should live with the duel instance. | Pending |
| `m_deck_`, `e_deck_` | **Yes** | The duel engine needs to know the decks to start. | Pending |

---

## 3. Core C-API Wrappers

These are the lowest-level private methods in `YGOProEnv` that call the C-API.

**Action:** These will be moved directly to `YgoCoreAdapter` and will likely become `private` methods there, called by the adapter's public interface.

| `YGOProEnv` Method | Target `YgoCoreAdapter` Method | `YGOProEnv`'s New Implementation | Status |
| :--- | :--- | :--- | :--- |
| `YGO_CreateDuel()` | `YgoCoreAdapter::YgoCoreAdapter(seed)` (Constructor) | `adapter_ = std::make_unique<YgoCoreAdapter>(seed);` | Adapted |
| `YGO_EndDuel()` | `YgoCoreAdapter::~YgoCoreAdapter()` (Destructor) | `adapter_.reset();` | Adapted |
| `YGO_SetPlayerInfo()` | `void set_player_info(...)` | `adapter_->set_player_info(...);` | Adapted |
| `YGO_NewCard()` | `void add_card(...)` | `adapter_->add_card(...);` | Adapted |
| `YGO_StartDuel()` | `void start_duel(...)` | `adapter_->start_duel(...);` | Adapted |
| `YGO_Process()` | `uint32_t process()` | `adapter_->process();` | Adapted |
| `YGO_GetMessage()` | `int32_t get_message(byte* buf)` | `adapter_->get_message(buf);` | Adapted |
| `YGO_QueryCard()` | `CardInfo query_card(...)` | `adapter_->query_card(...);` | Adapted |
| `YGO_QueryFieldCount()`| `int32_t query_field_count(...)` | `adapter_->query_field_count(...);` | Pending |
| `YGO_QueryFieldCard()`| `std::vector<CardInfo> query_field_card(...)` | `adapter_->query_field_card(...);` | Adapted |
| `YGO_SetResponsei()` | `void set_response(int32_t value)` | `adapter_->set_response(value);` | Adapted |
| `YGO_SetResponseb()` | `void set_response(const std::vector<byte>& buf)` | `adapter_->set_response(buf);` | Adapted |

---

## 4. Game State and Logic Functions

These methods in `YGOProEnv` manage the duel's lifecycle and state transitions. The adapter will expose new getter methods to provide state information to `YGOProEnv` after processing duel messages.

| `YGOProEnv` Method | Target `YgoCoreAdapter` Public Method | `YGOProEnv`'s New Implementation | Status |
| :--- | :--- | :--- | :--- |
| `new_duel(seed)` | `(Constructor)` | Initializes the adapter. | Adapted |
| `reset()` | `void reset()` (if needed) or handled by new duel creation. | Calls `adapter_.reset()` and creates a new one. | Pending |
| `next()` | N/A | Calls `adapter_->process_duel_messages()` then uses getters below. | Pending |
| `get_card_code()` | `CardCode get_card_code(...)` | `return adapter_->get_card_code(...);` | Pending |
| `get_card()` | `Card get_card(...)` | `return adapter_->get_card(...);` | Pending |
| `read_u8()`, `read_u16()`, `read_u32()` | Becomes private methods in `YgoCoreAdapter`. | No longer exists in `YGOProEnv`. | Pending |
| `q_read_u8()`, `q_read_u32()` | Becomes private methods in `YgoCoreAdapter`. | No longer exists in `YGOProEnv`. | Pending |
| N/A | `const std::vector<LegalAction>& get_legal_actions() const` | `legal_actions_ = adapter_->get_legal_actions();` | Pending |
| N/A | `bool is_duel_over() const` | `done_ = adapter_->is_duel_over();` | Pending |
| N/A | `PlayerId get_turn_player() const` | `tp_ = adapter_->get_turn_player();` | Pending |
| N/A | `GamePhase get_current_phase() const` | `current_phase_ = adapter_->get_current_phase();` | Pending |

---

## 5. YgoCoreAdapter Public API Mapping

This section defines the precise public interface for `YgoCoreAdapter`. Its primary responsibility is to process the duel engine's message queue and then provide the results to `YGOProEnv` through a clean, getter-based API.

| `YGOProEnv` State/Need | `YgoCoreAdapter` Public Method | Old `YGOProEnv` Implementation | Status |
| :--- | :--- | :--- | :--- |
| Advance the duel state | `void process_duel_messages()` | The `while` loop in `next()` that calls `YGO_Process` and `handle_message`. | Pending |
| Legal actions for player | `const std::vector<LegalAction>& get_legal_actions() const` | The `legal_actions_` member, populated by `handle_message`. | Pending |
| Is the duel finished? | `bool is_duel_over() const` | The `done_` member, set to true after a `MSG_WIN` message. | Pending |
| Reward for a player | `float get_reward(PlayerId player) const` | The `reward_` member, calculated based on the winner from `MSG_WIN`. | Pending |
| Current turn player | `PlayerId get_turn_player() const` | The `tp_` member, updated by `MSG_NEW_TURN`. | Pending |
| Current turn count | `int get_turn_count() const` | The `turn_count_` member, incremented by `MSG_NEW_TURN`. | Pending |
| Current game phase | `GamePhase get_current_phase() const` | The `current_phase_` member, updated by `MSG_NEW_PHASE`. | Pending |
| Query a single card | `CardInfo query_card(...)` | The `YGO_QueryCard` C-API wrapper. | Adapted |
| Query cards in locations | `std::vector<CardInfo> query_field_card(...)` | The `YGO_QueryFieldCard` C-API wrapper. | Adapted |
| Query card count | `int32_t query_field_count(...)` | The `YGO_QueryFieldCount` C-API wrapper. | Pending |

---

## 6. Message Handling & Action Generation

This is the most complex part of `YGOProEnv`. The `handle_message()` function is a giant `switch` statement that parses duel engine messages and populates `legal_actions_`.

**Action:** The entire `handle_message()` method and its many helpers will move into `YgoCoreAdapter` and become private. The adapter will expose a single public method, `process_duel_messages`, to advance the duel state.

| `YGOProEnv` Method | Target `YgoCoreAdapter` Public Method | `YGOProEnv`'s New Implementation | Status |
| :--- | :--- | :--- | :--- |
| `handle_message()` | `void process_duel_messages()` | `adapter_->process_duel_messages();` | Pending |
| `read_cardlist_spec()` | Becomes a private helper in `YgoCoreAdapter`. | No longer exists. | Pending |
| `get_actions_for_battle_cmd()` | Becomes a private helper in `YgoCoreAdapter`. | No longer exists. | Pending |
| `get_actions_for_idle_cmd()` | Becomes a private helper in `YgoCoreAdapter`. | No longer exists. | Pending |
| `get_actions_for_select_chain()`| Becomes a private helper in `YgoCoreAdapter`. | No longer exists. | Pending |
| ... (and all other sub-handlers for messages) | All become private helpers within `YgoCoreAdapter`. | No longer exist. | Pending |

The `YgoCoreAdapter` will internally call `YGO_Process()`, loop through `YGO_GetMessage()`, and run the message handling logic. This will update the adapter's internal state. `YGOProEnv` will then use public getter methods (e.g., `get_legal_actions()`, `is_duel_over()`) to retrieve the latest game state information.

---

## 7. Observation & State Serialization (`WriteState`)

The `WriteState` method is responsible for serializing the game state into the `State` object for the Python layer. It uses many helper methods (`_set_obs_*`) to do this.

**Action:** This logic will **remain in `YGOProEnv`**. However, instead of calling C-API query functions directly, it will call the new, clean query and getter methods on the adapter.

| `YGOProEnv` Method | New Implementation Detail | Status |
| :--- | :--- | :--- |
| `WriteState(State& state)` | The overall structure remains. | Pending |
| `_set_obs_global()` | Calls `adapter_->query_field_count()` and `adapter_->get_current_phase()`, etc. | Pending |
| `_set_obs_mask_()` | Calls `adapter_->query_field_card()` to get card data, then writes to the observation tensor. | Pending |
| `_set_obs_actions()` | Iterates through the `legal_actions_` vector, populated via `adapter_->get_legal_actions()`. | Pending |
| `spec_to_card_id()` | Remains in `YGOProEnv` but uses `adapter_->query_card()` to find card details if needed. | Pending |
| All other `_set_obs_*` helpers | Remain in `YGOProEnv` and operate on the data structures returned by the adapter's getters. | Pending |

This division of responsibility ensures the adapter is purely concerned with running the duel and understanding its state, while the environment is responsible for translating that state into the specific tensor format required by the learning algorithm. 